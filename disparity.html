<!DOCTYPE html>
<html>

<head>
    <title>Disparity</title>
    <link rel="stylesheet" type="text/css" href="camerastyle.css">

    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <script lang="javascript">
        //slider from: https://www.w3schools.com/howto/howto_js_rangeslider.asp
        var textsize = 200
        var draw

        class Camera {
                //https://www.markhansen.co.nz/javascript-optional-parameters/

            constructor(nested_svg,options) {
                this._fov = options.fov || 50;
                this._pixels = options.pixels || 20
                this._svg = nested_svg
                this.createSvg()
            }

            get pixels() {
                return this._pixels;
            }

            set pixels(pixels) {
                this._pixels = pixels
                this._svg.clear()
                this.createSvg()
            }

            set fov(fov){
                this._fov = fov
                this._svg.clear()
                //TODO: just change rotation angle.Faster?
                this.createSvg()
            }
            
            get fov(){
                return this._fov;
            }

            get nested_svg(){
                return this._svg
            }

            createSvg() {
                var cam1 = this._svg.circle(20).move(-10, -10).fill('#F00').id('cam')
                this.createNestedLines();
            }

            createNestedLines() {
                var strokelength = window.innerWidth
                var lines = this._svg.group()
                for (let angle = this.fov / -2; angle <= this.fov / 2; angle += this.fov / this._pixels) {
                    lines.line(0, 0, strokelength, 0).addClass('pixelline').rotate(angle, 0, 0)
                }
            }

            highlight(angle){
                // helper variable to only calculate from 0-fov degrees
                var angle_positive = angle + this.fov/2
                //remove existing highlights
                var lines_list = this._svg.find('.pixelline_highlight')
                lines_list.removeClass('pixelline_highlight')
                if(angle_positive > this.fov || angle_positive < 0)
                    //outside field of view
                    return;
                else{
                    var index = Math.floor(angle_positive/this.fov*this.pixels)
                    console.log(index);
                    this.nested_svg.children()[1].children()[index].addClass('pixelline_highlight')
                    this.nested_svg.children()[1].children()[index+1].addClass('pixelline_highlight')
                }

            }

        }

        SVG.on(document, 'DOMContentLoaded', function () {
            // var draw = SVG().addTo('body')

            var slider = document.getElementById("myRange");
            var output = document.getElementById("demo");

            var FoVslider = document.getElementById("myFoV");
            var FoVoutput = document.getElementById("FoVdemo");
            var x_offset  =30
            var no_of_pixels = 200


            draw = SVG().addTo('body').size(window.innerWidth, window.innerHeight).id('canvas');

            var cam1 = new Camera(draw.nested(),{fov:FoVslider.value,pixels:no_of_pixels})
            var cam2 = new Camera(draw.nested(),{fov:FoVslider.value,pixels:no_of_pixels})
        
            cam1.nested_svg.move(x_offset,100)
            cam2.nested_svg.move(x_offset,100)


            var measure_line1 = draw.line(x_offset, 0, 100, 100).addClass('measureline').move(cam1.nested_svg.x(), cam1.nested_svg.y()).id('ml1')
            var measure_line2 = draw.line(x_offset, 0, 100, 100).addClass('measureline').move(cam2.nested_svg.x(), cam2.nested_svg.y()).id('ml2')
            updateScreen(SVG(draw),cam1,cam2);

            var canvas = document.getElementById("canvas")
            canvas.onmousemove = function (event) {
                var x = event.x;
                var y = event.y;
                measure_line1.plot(cam1.nested_svg.x(), cam1.nested_svg.y(), x, y)
                measure_line2.plot(cam2.nested_svg.x(), cam2.nested_svg.y(), x, y)
                angle_deg_cam1 = 90 -( Math.atan2(x - cam1.nested_svg.x(), y -cam1.nested_svg.y())* 180 / Math.PI)
                angle_deg_cam2 = 90 -( Math.atan2(x - cam2.nested_svg.x(), y -cam2.nested_svg.y())* 180 / Math.PI)
                cam1.highlight(angle_deg_cam1)
                cam2.highlight(angle_deg_cam2)
                document.getElementById("angle").innerHTML = angle_deg_cam1

            }

            slider.oninput = function () {

                updateScreen(SVG(draw),cam1,cam2);
            }

            FoVslider.oninput = function () {
                cam1.fov=FoVslider.value
                cam2.fov=FoVslider.value
                updateScreen(SVG(draw), cam1,cam2);
            }

        })


        function updateScreen(drawsvg, cam1,cam2) {

            var output = document.getElementById("demo");
            var slider = document.getElementById("myRange");
            var slidevalue = output.innerHTML = slider.value;
            cam1.nested_svg.y((window.innerHeight / 2) - slidevalue*1)
            cam2.nested_svg.y((window.innerHeight / 2) + slidevalue*1)

            drawsvg.find('line#ml1').y(cam1.nested_svg.y())
            drawsvg.find('line#ml2').y(cam2.nested_svg.y())

            //document.getElementById('cam1').cx(slider.value)
            //draw.element('cam2').cy(slider.value)
            // screenupdater = setTimeout(UpdateScreen(),100)
        }
    </script>

</head>

<body style="margin:0;overflow-y: hidden">
    <div class="slidecontainer">
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
        <p>Distance: <span id="demo" style="position: relative;"></span></p>
    </div>
    <div class="slidecontainer" style="position: relative;">
        <input type="range" min="1" max="100" value="50" class="slider" id="myFoV">
        <p>FoV: <span id="FoVdemo" style="position: relative;"></span></p>
    </div>
    <div>angle1: <span id="angle">0</span></div>

</body>

</html>